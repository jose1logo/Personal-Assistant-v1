<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kai â€“ Personal Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* =========================
       THEME TOKENS
       ========================= */
    :root { --bg:#0f1115; --surface:#17191f; --surface-2:#1f2330; --border:#2a2f3b; --text:#e7e9ee; --muted:#a7b0c0; --primary:#8ab4f8; --accent:#66e3c4; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px; --radius-sm:10px; --radius-lg:20px; --focus:0 0 0 3px rgba(138,180,248,.35) }
    :root[data-theme="light"] { --bg:#f6f7fb; --surface:#fff; --surface-2:#f1f3f8; --border:#dfe3ec; --text:#0f1220; --muted:#58627a; --primary:#2563eb; --accent:#10b981; --shadow:0 10px 30px rgba(0,0,0,.08); --focus:0 0 0 3px rgba(37,99,235,.25) }

    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";background:radial-gradient(1200px 800px at 20% -10%,rgba(138,180,248,.12),transparent 60%),var(--bg);color:var(--text);display:grid;grid-template-rows:1fr}

    /* =========================
       LAYOUT
       ========================= */
    .app{display:grid;grid-template-columns:280px minmax(0,1fr);grid-template-rows:auto 1fr auto;min-height:100svh;height:100dvh;overflow:hidden;position:relative}
    /* When sidebar is hidden, expand content to full width */
    .app.sidebar-hidden{grid-template-columns:0 minmax(0,1fr)}
    @media (max-width:960px){.app{grid-template-columns:0 minmax(0,1fr)}}

    /* SIDEBAR */
    .sidebar{grid-row:1/span 3;grid-column:1;background:linear-gradient(180deg,var(--surface) 0%,var(--surface-2) 100%);border-right:1px solid var(--border);padding:18px;display:flex;flex-direction:column;gap:12px;transition:transform .28s ease;will-change:transform;z-index:20}
    .sidebar[aria-hidden="true"]{transform:translateX(-100%)}
    .sidebar-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 4px rgba(102,227,196,.2)}

    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:38px;height:38px;border-radius:999px;cursor:pointer;background:var(--surface);border:1px solid var(--border);color:var(--text);transition:background .2s ease,border-color .2s ease,transform .06s ease}
    .icon-btn:hover{border-color:var(--primary)}.icon-btn:active{transform:translateY(1px)}.icon-btn:focus-visible{outline:none;box-shadow:var(--focus)}

    .new-chat{display:inline-flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:var(--radius);cursor:pointer;box-shadow:var(--shadow)}

    .history-search{position:relative}
    .history-search input{width:100%;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 12px 10px 36px;border-radius:var(--radius)}
    .history-search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .history{flex:1 1 auto;overflow:auto;margin-top:6px;padding-right:4px}
    .history-item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px;border-radius:var(--radius-sm);cursor:pointer;border:1px solid transparent;color:var(--text)}
    .history-item:hover{background:var(--surface);border-color:var(--border)}
    .history-item.active{background:rgba(138,180,248,.10);border-color:var(--primary)}

    /* HEADER */
    .header{grid-column:2;display:flex;align-items:center;justify-content:space-between;padding:16px 20px;gap:10px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(0,0,0,.0) 0%,rgba(0,0,0,.08) 100%);position:sticky;top:0;z-index:10;backdrop-filter:blur(6px)}
    .title{font-size:20px;font-weight:600;color:var(--primary);margin:0}
    .header-actions{display:flex;align-items:center;gap:8px}

    /* CHAT */
    .chat{grid-column:2;position:relative;display:grid;grid-template-rows:1fr auto;min-height:0}
    .messages{overflow:auto;padding:28px 20px 20px;display:grid;gap:18px;align-content:start}

    .msg{max-width:820px;width:100%;margin:0 auto;display:grid;grid-template-columns:40px 1fr;gap:12px;align-items:start;animation:fadeIn .2s ease}
    .avatar{width:40px;height:40px;border-radius:50%;background:var(--surface-2);border:1px solid var(--border);display:grid;place-items:center;font-weight:700}
    .bubble{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:14px 16px;line-height:1.6;box-shadow:var(--shadow)}
    .bubble.user{background:linear-gradient(180deg,rgba(138,180,248,.12),rgba(138,180,248,.08));border-color:rgba(138,180,248,.25)}
    .bubble .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;margin-top:8px}
    .msg.user{grid-template-columns:1fr 40px}
    .msg.user .avatar{order:2;background:var(--primary);color:#0b1220}

    /* Composer */
    .composer{position:sticky;bottom:0;left:0;right:0;display:grid;gap:10px;padding:14px 20px 18px;background:linear-gradient(0deg,rgba(0,0,0,.18) 0%,rgba(0,0,0,0) 100%)}
    .input-wrap{max-width:820px;width:100%;margin:0 auto;display:grid;grid-template-columns:1fr auto auto;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:8px;box-shadow:var(--shadow)}
    textarea#user-input{resize:none;background:transparent;border:0;color:var(--text);padding:12px 14px;font:inherit;line-height:1.5;max-height:180px;min-height:24px}
    textarea#user-input:focus{outline:none}
    .send-btn{align-self:end;width:42px;height:42px;border-radius:999px;border:1px solid var(--border);background:var(--primary);color:#0b1220;display:grid;place-items:center;cursor:pointer;transition:filter .2s ease,transform .06s ease,box-shadow .2s ease}
    .send-btn:hover{filter:brightness(1.03)}.send-btn:active{transform:translateY(1px)}.send-btn:disabled{opacity:.5;cursor:not-allowed}
    .mic-btn{align-self:end;width:42px;height:42px;border-radius:999px;border:1px solid var(--border);background:var(--surface-2);color:var(--text);display:grid;place-items:center;cursor:pointer;transition:background .2s ease,transform .06s ease,box-shadow .2s ease}
    .mic-btn:hover{background:var(--surface-2)}
    .mic-btn.recording{background:var(--accent);color:#0b1220}

    .recording-visualizer {
        display: none; /* Initially hidden */
        align-items: center;
        gap: 10px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 8px;
        box-shadow: var(--shadow);
        max-width: 820px;
        width: 100%;
        margin: 0 auto;
    }
    #visualizerCanvas {
        flex-grow: 1;
        height: 42px;
    }

    .helper-row{max-width:820px;width:100%;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 6px;color:var(--muted);font-size:12px}

    /* Typing */
    .typing{display:inline-flex;gap:4px;padding:10px 12px;border-radius:12px;border:1px dashed var(--border);background:rgba(138,180,248,.06)}
    .typing span{width:6px;height:6px;border-radius:50%;background:var(--primary);display:inline-block;animation:bounce 1s infinite ease-in-out}
    .typing span:nth-child(2){animation-delay:.15s}.typing span:nth-child(3){animation-delay:.3s}

    /* Scroll to bottom */
    .scroll-bottom{position:fixed;right:24px;bottom:100px;z-index:15;opacity:0;pointer-events:none;transform:translateY(8px);transition:opacity .2s ease,transform .2s ease}
    .scroll-bottom.show{opacity:1;pointer-events:auto;transform:translateY(0)}

    /* FIXED: Single sidebar toggle button */
    .sidebar-toggle{
      position:fixed;
      left:20px;
      top:20px;
      z-index:50;
      background:var(--surface);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      transform:translateX(0);
    }
    
    .sidebar-toggle:hover{
      background:var(--surface-2);
      border-color:var(--primary);
      transform:scale(1.05);
    }
    
    .sidebar-toggle:active{
      transform:scale(0.95);
    }
    
    /* Hide the toggle when sidebar is visible */
    .app:not(.sidebar-hidden) .sidebar-toggle{
      opacity:0;
      pointer-events:none;
      transform:translateX(-20px);
    }
    
    /* Show the toggle when sidebar is hidden */
    .app.sidebar-hidden .sidebar-toggle{
      opacity:1;
      pointer-events:auto;
      transform:translateX(0);
    }
    
    /* Toggle icon rotation animation */
    .sidebar-toggle svg{
      transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .app.sidebar-hidden .sidebar-toggle svg{
      transform:rotate(180deg);
    }

    .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden;white-space:nowrap}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-3px)}}
    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Chat history" aria-hidden="false">
      <div class="sidebar-header">
        <div class="brand"><span class="brand-dot" aria-hidden="true"></span> Kai</div>
      </div>
      <button class="new-chat" id="newChat"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> New chat</button>
      <div class="history-search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input id="historyFilter" placeholder="Search conversationsâ€¦" aria-label="Search chat history" />
      </div>
      <nav class="history" id="history" aria-live="polite"></nav>
    </aside>

    <!-- Header -->
    <header class="header">
      <h1 class="title">Kai</h1>
      <div class="header-actions">
        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        </button>
      </div>
    </header>

    <!-- Chat area -->
    <main class="chat" aria-label="Conversation">
      <section class="messages" id="messages">
        <article class="msg bot">
          <div class="avatar" aria-hidden="true">K</div>
          <div class="bubble" role="status">
            <p>Hi! I'm Kai. How can I help today?</p>
          </div>
        </article>
      </section>

      <div class="composer">
        <div class="input-wrap" id="inputWrap">
          <label for="user-input" class="visually-hidden">Message Kai</label>
          <textarea id="user-input" placeholder="Message Kaiâ€¦" rows="1" autocomplete="off"></textarea>
          <button class="mic-btn" id="micBtn" aria-label="Record message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
          </button>
          <button class="send-btn" id="sendBtn" aria-label="Send message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
          </button>
        </div>
        <div class="recording-visualizer" id="recordingVisualizer">
            <button class="icon-btn" id="cancelRecordingBtn" aria-label="Cancel recording">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <canvas id="visualizerCanvas"></canvas>
            <button class="icon-btn" id="confirmRecordingBtn" aria-label="Confirm recording">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
            </button>
        </div>
        <div class="helper-row">
          <div>Press <kbd>Enter</kbd> to send Â· <kbd>Shift</kbd>+<kbd>Enter</kbd> for a new line</div>
          <div id="charCounter" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <button class="icon-btn scroll-bottom" id="scrollBottom" aria-label="Scroll to latest">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
    </button>

    <!-- Single sidebar toggle button -->
    <button class="icon-btn sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    const converter = (window.showdown && typeof window.showdown.Converter === 'function')
      ? new window.showdown.Converter({ simplifiedAutoLink:true, strikethrough:true, tables:true, tasklists:true, openLinksInNewWindow:true })
      : { makeHtml: s => String(s || '') };

    function sanitizeHTML(html){ const tpl=document.createElement('template'); tpl.innerHTML=html; const bad=new Set(['script','style','iframe','object','embed','link','meta']); const w=document.createTreeWalker(tpl.content, NodeFilter.SHOW_ELEMENT); const rm=[]; while(w.nextNode()){ const el=w.currentNode; const tag=el.tagName.toLowerCase(); if(bad.has(tag)) rm.push(el); [...el.attributes].forEach(a=>{ const n=a.name.toLowerCase(); const v=a.value; if(n.startsWith('on')) el.removeAttribute(a.name); if((n==='href'||n==='src')&&/^javascript:/i.test(v)) el.removeAttribute(a.name); if(n==='style'&&/expression|url\(/i.test(v)) el.removeAttribute(a.name); if(tag==='a'&&el.hasAttribute('target')) el.setAttribute('rel','nofollow noopener noreferrer'); }); } rm.forEach(n=>n.remove()); return tpl.innerHTML; }

    function autogrow(t){ t.style.height='auto'; t.style.height=Math.min(t.scrollHeight,180)+'px'; }
    function timeNow(){ return new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }

    // Elements
    const app = document.getElementById('app');
    const messagesEl = document.getElementById('messages');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const newChat = document.getElementById('newChat');
    const inputWrap = document.getElementById('inputWrap');
    const recordingVisualizer = document.getElementById('recordingVisualizer');
    const canvas = document.getElementById('visualizerCanvas');
    const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
    const confirmRecordingBtn = document.getElementById('confirmRecordingBtn');
    const historyEl = document.getElementById('history');
    const historyFilter = document.getElementById('historyFilter');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const scrollBottomBtn = document.getElementById('scrollBottom');

    let currentSessionId = null; let allSessions = [];
    let mediaRecorder;
    let audioChunks = [];
    let audioContext, analyser, animationFrameId;
    const canvasCtx = canvas.getContext('2d');

    function visualize(stream) {
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close();
        }
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);

        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        function draw() {
            animationFrameId = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);

            const style = getComputedStyle(document.body);
            const surfaceColor = style.getPropertyValue('--surface').trim();
            const mutedColor = style.getPropertyValue('--muted').trim();

            canvasCtx.fillStyle = surfaceColor;
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = 2;
            const barGap = 2;
            const totalBarWidth = bufferLength * (barWidth + barGap);
            let x = (canvas.width - totalBarWidth) / 2; // Center the waveform
            const centerY = canvas.height / 2;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 2.5; // Make it a bit smaller
                canvasCtx.fillStyle = mutedColor;
                canvasCtx.fillRect(x, centerY - barHeight / 2, barWidth, barHeight);
                x += barWidth + barGap;
            }
        }
        draw();
    }

    function stopVisualization() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close();
            audioContext = null;
        }
        inputWrap.style.display = 'grid';
        recordingVisualizer.style.display = 'none';
    }

    micBtn.addEventListener('click', async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            return; // Already recording, let confirm/cancel handle it
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            inputWrap.style.display = 'none';
            recordingVisualizer.style.display = 'flex';
            visualize(stream);

            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            mediaRecorder.onstop = async () => {
                stream.getTracks().forEach(track => track.stop());
                stopVisualization();
                if (!audioChunks.length) return;

                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioChunks = [];
                const formData = new FormData();
                formData.append('audio_data', audioBlob, 'audio.webm');
                try {
                    const res = await fetch('/transcribe', { method: 'POST', body: formData });
                    if (res.ok) {
                        const data = await res.json();
                        input.value = data.text;
                        autogrow(input);
                    }
                } catch (e) { console.error(e); }
            };
        } catch (e) {
            console.error('Error accessing microphone:', e);
            inputWrap.style.display = 'grid';
            recordingVisualizer.style.display = 'none';
        }
    });

    confirmRecordingBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    });

    cancelRecordingBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            audioChunks = []; // Discard audio
            mediaRecorder.stop();
        }
    });

    function makeCopyTextFromBubble(bubble){ const tmp=bubble.cloneNode(true); tmp.querySelectorAll('.meta, .icon-btn').forEach(n=>n.remove()); return tmp.textContent.trim(); }

    function msgTemplate(role, content){
      const isUser = role === 'user';
      const wrapper = document.createElement('article'); wrapper.className = `msg ${isUser ? 'user' : 'bot'}`;
      const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = isUser ? 'U' : 'K';
      const bubble = document.createElement('div'); bubble.className = `bubble ${isUser ? 'user' : ''}`;
      if (!isUser){ const md = converter.makeHtml(String(content ?? '')); bubble.innerHTML = sanitizeHTML(md); } else { bubble.textContent = content; }
      const meta = document.createElement('div'); meta.className = 'meta'; meta.innerHTML = `<span>${timeNow()}</span>`; bubble.appendChild(meta);
      if (!isUser){
        const copyBtn = document.createElement('button'); copyBtn.className = 'icon-btn'; copyBtn.style.marginTop = '8px'; copyBtn.title = 'Copy'; copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>'; copyBtn.addEventListener('click', async ()=>{ const text = makeCopyTextFromBubble(bubble); try{ await navigator.clipboard.writeText(text);}catch{} });

        const playBtn = document.createElement('button'); playBtn.className = 'icon-btn'; playBtn.style.marginTop = '8px'; playBtn.style.marginLeft = '8px'; playBtn.title = 'Play'; playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>'; playBtn.addEventListener('click', async () => {
            const text = makeCopyTextFromBubble(bubble);
            try {
                const res = await fetch('/speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (res.ok) {
                    const audioBlob = await res.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (e) {
                console.error(e);
            }
        });

        bubble.appendChild(copyBtn);
        bubble.appendChild(playBtn);
      }
      if (isUser){ wrapper.appendChild(bubble); wrapper.appendChild(avatar); } else { wrapper.appendChild(avatar); wrapper.appendChild(bubble); }
      return wrapper;
    }

    function updateScrollButton(){ const atBottom = Math.abs(messagesEl.scrollHeight - messagesEl.clientHeight - messagesEl.scrollTop) < 4; scrollBottomBtn.classList.toggle('show', !atBottom); }
    function addMessage(content, role='bot'){ const node = msgTemplate(role, content); messagesEl.appendChild(node); messagesEl.scrollTop = messagesEl.scrollHeight; updateScrollButton(); }
    function showTyping(){ const n=document.createElement('article'); n.className='msg bot'; n.id='typingRow'; n.innerHTML='<div class="avatar">K</div><div class="bubble"><div class="typing" aria-live="polite"><span></span><span></span><span></span></div></div>'; messagesEl.appendChild(n); messagesEl.scrollTop = messagesEl.scrollHeight; updateScrollButton(); }
    function hideTyping(){ const n=document.getElementById('typingRow'); if(n) n.remove(); updateScrollButton(); }

    async function sendMessage(){ const text = input.value.trim(); if(!text) return; addMessage(text,'user'); input.value=''; autogrow(input); sendBtn.disabled=true; showTyping(); try{ const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message:text, session_id: currentSessionId }) }); const ok = res.ok; const data = ok ? await res.json() : null; hideTyping(); sendBtn.disabled=false; if(ok && data && data.response){ addMessage(data.response,'bot'); if(data.session_id && !currentSessionId){ currentSessionId = data.session_id; await loadHistory(); } } else { addMessage('Backend is not responding yet. Check your /chat route.', 'bot'); } } catch(e){ console.error(e); hideTyping(); sendBtn.disabled=false; addMessage('Network error. Is the server running?', 'bot'); } }

    async function loadHistory(){ try{ const res = await fetch('/history'); if(!res.ok) throw new Error('history '+res.status); const data = await res.json(); allSessions = Array.isArray(data) ? data : []; renderHistory(); } catch(e){ console.warn('History unavailable', e); allSessions = []; renderHistory(); } }

    function renderHistory(){ const q=(historyFilter.value||'').toLowerCase().trim(); historyEl.innerHTML=''; allSessions.filter(s=>!q||(s.summary||'').toLowerCase().includes(q)).forEach(session=>{ const item=document.createElement('div'); item.className='history-item'+(session.id===currentSessionId?' active':''); item.setAttribute('role','button'); item.setAttribute('tabindex','0'); item.dataset.sessionId=session.id; const label=document.createElement('div'); label.className='label'; label.textContent=session.summary||'Untitled conversation'; const small=document.createElement('small'); const ts=session.created_at?new Date(session.created_at):new Date(); small.textContent=ts.toLocaleDateString(); item.appendChild(label); item.appendChild(small); item.addEventListener('click',()=>openSession(session.id)); item.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openSession(session.id);} }); historyEl.appendChild(item); }); }

    async function openSession(id){ try{ const res=await fetch(`/history/${id}`); const data = res.ok ? await res.json() : []; currentSessionId=id; $$('.history-item').forEach(i=>i.classList.toggle('active', i.dataset.sessionId===id)); messagesEl.innerHTML=''; (data||[]).forEach(m=>addMessage(m.text,m.role)); } catch(e){ console.error(e); }
    }

    // Sidebar visibility with animations
    function setSidebarHidden(hidden){ 
      sidebar.setAttribute('aria-hidden', String(hidden)); 
      sidebarToggle.setAttribute('aria-expanded', String(!hidden)); 
      app.classList.toggle('sidebar-hidden', hidden);
    }

    // Bind events
    document.addEventListener('DOMContentLoaded', ()=>{
      input.addEventListener('input', ()=>{ autogrow(input); document.getElementById('charCounter').textContent = `${input.value.length} chars`; });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
      sendBtn.addEventListener('click', sendMessage);
      newChat.addEventListener('click', ()=>{ currentSessionId=null; messagesEl.innerHTML=''; addMessage("Hi! I\'m Kai. How can I help today?", 'bot'); document.querySelectorAll('.history-item').forEach(n=>n.classList.remove('active')); input.focus(); });
      sidebarToggle.addEventListener('click', ()=>{ 
        const hidden = sidebar.getAttribute('aria-hidden') === 'true' ? false : true; 
        setSidebarHidden(hidden); 
      });
      historyFilter.addEventListener('input', renderHistory);
      messagesEl.addEventListener('scroll', updateScrollButton);
      scrollBottomBtn.addEventListener('click', ()=> messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior:'smooth' }));

      // Theme persistence
      const THEME_KEY='kai-theme';
      const applyTheme = t => document.documentElement.dataset.theme = t;
      const savedTheme = localStorage.getItem(THEME_KEY); applyTheme(savedTheme||'dark');
      document.getElementById('themeToggle').addEventListener('click', ()=>{ const curr=document.documentElement.dataset.theme||'dark'; const next= curr==='light'?'dark':'light'; applyTheme(next); localStorage.setItem(THEME_KEY,next); });

      // Kickoff
      autogrow(input); loadHistory();
    });
  </script>
</body>
</html>
